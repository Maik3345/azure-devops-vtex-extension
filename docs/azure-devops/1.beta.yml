parameters:
  - name: account
    type: string
  - name: email
    type: string
  - name: apiKey
    type: string
  - name: apiToken
    type: string
  - name: environment
    type: string
  - name: publishCommand
    type: string
    default: 'projex vtex run "npm run publish"'
  - name: devBranch
    type: string
    default: "develop"

jobs:
  - job: Beta
    displayName: "Generate a Beta Version ğŸ”–"
    steps:
      - checkout: self
        persistCredentials: true

      - task: PullRequestChangeOriginToSourceBranch@1
        displayName: "ğŸ”„ Switch to Source Branch"

      - task: ProjectSetupDependencies@1
        displayName: "ğŸ“¦ Install Project Dependencies"

      - task: VtexLogin@1
        displayName: "ğŸ”‘ VTEX IO Authentication"
        inputs:
          apiKey: ${{ parameters.apiKey }}
          apiToken: ${{ parameters.apiToken }}
          email: ${{ parameters.email }}
          account: ${{ parameters.account }}

      - task: VtexPullRequestPublish@0
        displayName: "ğŸš€ Publish Beta Version"
        inputs:
          publishCommand: ${{ parameters.publishCommand }}

  - job: BetaRelease
    displayName: "Generate a Beta Release ğŸ“¦ï¸"
    dependsOn: Beta
    steps:
      - checkout: self
        persistCredentials: true

      - task: ProjectSetupDependencies@1
        displayName: "ğŸ“¦ Install Project Dependencies"
        inputs:
          installVtex: false

      - task: GitPullRequestRelease@0
        displayName: "ğŸ·ï¸ Create Beta Release Tag"

      - task: GitPullRequestMergeIntoBranch@0
        displayName: "ğŸ”€ Merge into ${{ parameters.devBranch }} Branch"
        inputs:
          branch: ${{ parameters.devBranch }}
